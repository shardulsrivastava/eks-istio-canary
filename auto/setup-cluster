#!/usr/bin/env bash

set -euo pipefail

cd "$(dirname "$0")/.."

function green() {
    text="${1:- }"
    echo -e "\033[32m${text}\033[0m"
}

green "Deploying Cluster => canary-cluster"
eksctl create cluster -f canary-cluster.yaml 

green "Cluster => "
kubectl config current-context

green "Setting up Istio"
istioctl install --set profile=default -y

green "Adding Istio label to default namespace"
kubectl label namespace default istio-injection=enabled

green "Deploying Sample application and Kiali CRD"
kubectl apply -f manifests/

green "Deploying Istio addons"
kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.10.3/samples/addons/prometheus.yaml
kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.10.3/samples/addons/grafana.yaml
kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.10.3/samples/addons/kiali.yaml

